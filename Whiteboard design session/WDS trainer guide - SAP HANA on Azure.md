![Microsoft Cloud Workshops](https://github.com/Microsoft/MCW-Template-Cloud-Workshop/raw/master/Media/ms-cloud-workshop.png "Microsoft Cloud Workshops")


<div class="MCWHeader1">
SAP HANA on Azure
</div>

<div class="MCWHeader2">
 Whiteboard design session trainer guide
</div>

<div class="MCWHeader3">
October 2018
</div>



Information in this document, including URL and other Internet Web site references, is subject to change without notice. Unless otherwise noted, the example companies, organizations, products, domain names, e-mail addresses, logos, people, places, and events depicted herein are fictitious, and no association with any real company, organization, product, domain name, e-mail address, logo, person, place or event is intended or should be inferred. Complying with all applicable copyright laws is the responsibility of the user. Without limiting the rights under copyright, no part of this document may be reproduced, stored in or introduced into a retrieval system, or transmitted in any form or by any means (electronic, mechanical, photocopying, recording, or otherwise), or for any purpose, without the express written permission of Microsoft Corporation.

Microsoft may have patents, patent applications, trademarks, copyrights, or other intellectual property rights covering subject matter in this document. Except as expressly provided in any written license agreement from Microsoft, the furnishing of this document does not give you any license to these patents, trademarks, copyrights, or other intellectual property.

The names of manufacturers, products, or URLs are provided for informational purposes only and Microsoft makes no representations and warranties, either expressed, implied, or statutory, regarding these manufacturers or the use of the products with any Microsoft technologies. The inclusion of a manufacturer or product does not imply endorsement of Microsoft of the manufacturer or product. Links may be provided to third party sites. Such sites are not under the control of Microsoft and Microsoft is not responsible for the contents of any linked site or any link contained in a linked site, or any changes or updates to such sites. Microsoft is not responsible for webcasting or any other form of transmission received from any linked site. Microsoft is providing these links to you only as a convenience, and the inclusion of any link does not imply endorsement of Microsoft of the site or the products contained therein.

© 2018 Microsoft Corporation. All rights reserved.

Microsoft and the trademarks listed at https://www.microsoft.com/en-us/legal/intellectualproperty/Trademarks/Usage/General.aspx are trademarks of the Microsoft group of companies. All other trademarks are property of their respective owners.


**Contents**

<!-- TOC -->

- [Trainer information](#trainer-information)
    - [Role of the trainer](#role-of-the-trainer)
    - [Whiteboard design session flow](#whiteboard-design-session-flow)
    - [Before the whiteboard design session: How to prepare](#before-the-whiteboard-design-session-how-to-prepare)
    - [During the whiteboard design session: Tips for an effective whiteboard design session](#during-the-whiteboard-design-session-tips-for-an-effective-whiteboard-design-session)
- [SAP HANA on Azure whiteboard design session student guide](#sap-hana-on-azure-whiteboard-design-session-student-guide)
    - [Abstract and learning objectives](#abstract-and-learning-objectives)
    - [Step 1: Review the customer case study](#step-1-review-the-customer-case-study)
        - [Customer situation](#customer-situation)
        - [Customer needs](#customer-needs)
        - [Customer objections](#customer-objections)
        - [Infographic for common scenarios](#infographic-for-common-scenarios)
    - [Step 2: Design a proof of concept solution](#step-2-design-a-proof-of-concept-solution)
    - [Step 3: Present the solution](#step-3-present-the-solution)
    - [Wrap-up](#wrap-up)
    - [Additional references](#additional-references)
- [SAP HANA on Azure whiteboard design session trainer guide](#sap-hana-on-azure-whiteboard-design-session-trainer-guide)
    - [Step 1: Review the customer case study](#step-1-review-the-customer-case-study-1)
    - [Step 2: Design a proof of concept solution](#step-2-design-a-proof-of-concept-solution-1)
    - [Step 3: Present the solution](#step-3-present-the-solution-1)
    - [Wrap-up](#wrap-up-1)
    - [Preferred target audience](#preferred-target-audience)
    - [Preferred solution](#preferred-solution)
    - [Checklist of preferred objection handling](#checklist-of-preferred-objection-handling)
    - [Customer quote (to be read back to the attendees at the end)](#customer-quote-to-be-read-back-to-the-attendees-at-the-end)

<!-- /TOC -->

# Trainer information

Thank you for taking time to support the whiteboard design sessions as a trainer!

## Role of the trainer

An amazing trainer:

-   Creates a safe environment in which learning can take place

-   Stimulates the participant's thinking

-   Involves the participant in the learning process

-   Manages the learning process (on time, on topic, and adjusting to benefit participants)

-   Ensures individual participant accountability

-   Ties it all together for the participant

-   Provides insight and experience to the learning process

-   Effectively leads the whiteboard design session discussion

-   Monitors quality and appropriateness of participant deliverables

-   Effectively leads the feedback process

## Whiteboard design session flow 

Each whiteboard design session uses the following flow:

**Step 1: Review the customer case study (15 minutes)**

Outcome: Analyze your customer's needs.

-   Customer's background, situation, needs and technical requirements

-   Current customer infrastructure and architecture

-   Potential issues, objectives and blockers

**Step 2: Design a proof of concept solution (60 minutes)**

Outcome: Design a solution and prepare to present the solution to the target customer audience in a 15-minute chalk-talk format.

-   Determine your target customer audience

-   Determine customer's business needs to address your solution

-   Design and diagram your solution

-   Prepare to present your solution

**Step 3: Present the solution (30 minutes)**

Outcome: Present solution to your customer.

-   Present solution

-   Respond to customer objections

-   Receive feedback

**Wrap-up (15 minutes)**

-   Review preferred solution

## Before the whiteboard design session: How to prepare

Before conducting your first whiteboard design session:

-   Read the Student guide (including the case study) and Trainer guide

-   Become familiar with all key points and activities

-   Plan the point you want to stress, which questions you want to drive, transitions, and be ready to answer questions

-   Prior to the whiteboard design session, discuss the case study to pick up more ideas

-   Make notes for later

## During the whiteboard design session: Tips for an effective whiteboard design session

**Refer to the Trainer guide** to stay on track and observe the timings.

**Do not expect to memorize every detail** of the whiteboard design session.

When participants are doing activities, you can **look ahead to refresh your memory**.

-   **Adjust activity and whiteboard design session pace** as needed to allow time for presenting, feedback, and sharing

-   **Add examples, points, and stories** from your own experience. Think about stories you can share that help you make your points clearly and effectively.

-   **Consider creating a "parking lot"** to record issues or questions raised that are outside the scope of the whiteboard design session or can be answered later. Decide how you will address these issues, so you can acknowledge them without being derailed by them.

***Have fun**! Encourage participants to have fun and share!*

**Involve your participants.** Talk and share your knowledge but always involve your participants, even while you are the one speaking.

**Ask questions** and get them to share to fully involve your group in the learning process.

**Ask first**, whenever possible. Before launching into a topic, learn your audience's opinions about it and experiences with it. Asking first enables you to assess their level of knowledge and experience, and leaves them more open to what you are presenting.

**Wait for responses**. If you ask a question such as, "What's your experience with (fill in the blank)?" then wait. Do not be afraid of a little silence. If you leap into the silence, your participants will feel you are not serious about involving them and will become passive. Give participants a chance to think, and if no one answers, patiently ask again. You will usually get a response.

# SAP HANA on Azure whiteboard design session student guide

## Abstract and learning objectives 

In this Whiteboard Design Session, you will look at what is involved in deploying SAP HANA on Azure with the goals of designing for high availability, disaster recovery as well as supportability.

At the end of this whiteboard design session you will be able to better design and deploy SAP HANA on Azure.

## Step 1: Review the customer case study 

**Outcome**

Analyze your customer's needs.

Timeframe: 15 minutes

Directions: With all participants in the session, the facilitator/SME presents an overview of the customer case study along with technical tips.

1.  Meet your table participants and trainer

2.  Read all of the directions for steps 1--3 in the student guide

3.  As a table team, review the following customer case study

### Customer situation

Contoso Group is a global pharmaceutical company with its headquarters based in Boston, US.

Contoso has been using SAP ERP and BW on HANA for its Finance/Logistics/Analytics systems on the HP-UX/Oracle platform.

Contoso Leadership and Planning Groups wants to drastically reduce server and storage hardware in their own datacenters to minimize IT related costs. Contoso has already a number of their non-SAP systems migrated to Azure. The leadership asked Contoso IT to look into the possibility of migrating its SAP HANA environment to cloud.

Contoso IT decided to leverage its knowledge of the Microsoft cloud platform and existing ExpressRoute connectivity and host its SAP landscape in Azure. The intention is to migrate the BW system first (go live in March CY19), and migrate ECC in Q4 of CY19. The multi-stage approach is supposed to minimize potential migration risks.

Considering that Contoso management team often uses BW to support their management decisions, the systems should be highly available, and their performance must be predictable and consistent. In addition, the management team wants to leverage disaster recovery capabilities offered by Azure in order to ensure resiliency of the migrated environment in case the primary region hosting the new deployment becomes unavailable.

As Andrew Cross, CIO of Contoso Group emphasized this point by stating "Our operational dependencies on SAP applications force us to seek reasonably priced availability and disaster recovery capabilities for our production SAP HANA deployments."

Before migrating the production environment, Contoso wants to test its new deployment approach by provisioning training, development, test, and UAT environments in Azure.

### Customer needs 

-   Highly responsive systems with low network latency
-   In-memory database performance
-   High availability & disaster recovery
-   Enterprise data protection & security
-   Safe migration with downtime minimized
-   Access from HANA-based applications
-   Minimized cost

1.  Design scope:

    -   BW migration to HANA in Azure VMs

        -   Go-live date: March 2019

        -   Current BW (ABAP Unicode) on-premises with HP-UX/Oracle and application layer on Linux

        -   Customer requests flexible VM solution within Cloud to accommodate the BW workloads

            -   Use 1-year Reserved VM Instance option for Production VMs

    -   ERP is kept on-premises (with HP-UX/Oracle) until December 2019

        -   Data is transferred from ERP (on-premises) to BW (in Cloud) every hour

    -   (Option) Need to start to prepare for ERP migration to Cloud

2.  Target environment:

    -   Sizing

        -   Production (3-tier) with latest OS/DB fully certified and supported by SAP

            -   HANA sizing memory requirement 1.2 TB, estimate 1.9 TB in 3 years

            -   Throughput DB files at least 400MB/s \[/hana/data\]

            -   Throughput DB Log files at least 250MB/s \[/hana/log\]

            -   BW application servers: 15K SAPS

        -   Certification is NOT required for non-Prod

            -   QA (2-tier) HANA database server: 800 GB

            -   Dev, Test (both 2-tier) HANA database server(s): 256 GB

    -   Uptime -- Prod: 24x7, 744 hours/month, QA - 50 hours/month, DEV/Test - 200 hours/month

3.  High availability and disaster recovery

    -   Availability

        -   Both HA and Non-HA options need to be proposed

        -   With HA option, in case of server/storage issues, auto failover to complete within a few minutes, in case of a disaster recovery within 1 day

    -   Backup

        -   Long term backup -- use backup storage in Cloud

        -   Data loss not allowed

        -   HANA DB log backup taken every 30 minutes

        -   DB log backup to be kept for 1 day (DB restore to be fast)

        -   HANA DB full backup every night

        -   Daily HANA DB full backup to be retained for 1 month

        -   Monthly HANA DB full backup for 1 year, annual for 3 years

4.  End user access

    -   User locations -- 300 from US, 50 LATAM, 50 Europe, 30 Asia - all intranet

    -   Currently ExpressRoute is set up to Azure East US 2

    -   Response time needs to be minimized

### Customer objections 

1.  ECC remains on-premises until Dec CY19. How can we maintain integrations between ECC and BW?

2.  How much does Azure cost? Give us a few options (e.g. HA and non-HA, DR and non-DR).

3.  Do I have to pay for virtual machines when they are stopped?

4.  Can I automate the shutdown of virtual machines at specific times of day?

### Infographic for common scenarios

![Common solutions for the case study.](images/CommonScenarios.png "Common Scenarios")

## Step 2: Design a proof of concept solution

**Outcome**

Design a solution and prepare to present the solution to the target customer audience in a 15-minute chalk-talk format.

Timeframe: 60 minutes

**Business needs**

Directions: With all participants at your table, answer the following questions and list the answers on a flip chart.

1.  Who should you present this solution to? Who is your target customer audience? Who are the decision makers?

2.  What customer business needs do you need to address with your solution?

**Design**

Directions: With all participants at your table, respond to the following questions on a flip chart.

*High-level solution architecture:*

1.  What should be the Azure region(s) where the solution will be deployed?

2.  Should the customer use a 2-tier or 3-tier architecture for its SAP deployment?

3.  How would you ensure that the high-availability and disaster recovery requirements are satisfied?

*Network design:*

1.  What should be the hybrid connectivity option?

2.  What should be the Azure virtual network design in order to maximize security?

*SAP deployment architecture:*

1.  What will be the configuration of the configuration of the application and database components of your solution?

2.  What Azure VM sizes do you intend to use?

3.  What other Azure resources will be part of your solution?

*Solution cost:*

1.  What is the estimated cost of your solution without HA/DR?

2.  What is the estimated cost of your solution with HA?

3.  What is the estimated cost of your solution with HA/DR?

**Prepare**

Directions: With all participants at your table: 

1.  Identify any customer needs that are not addressed with the proposed solution
2.  Identify the benefits of your solution
3.  Determine how you will respond to the customer’s objections

Prepare a 15-minute chalk-talk style presentation to the customer. 

## Step 3: Present the solution

**Outcome**
 
Present a solution to the target customer audience in a 15-minute chalk-talk format.

Timeframe: 30 minutes

**Presentation** 

Directions:
1.  Pair with another table
2.  One table is the Microsoft team and the other table is the customer
3.  The Microsoft team presents their proposed solution to the customer
4.  The customer makes one of the objections from the list of objections
5.  The Microsoft team responds to the objection
6.  The customer team gives feedback to the Microsoft team.
7.  Tables switch roles and repeat Steps 2–6

##  Wrap-up 

Timeframe: 15 minutes

Directions: Tables reconvene with the larger group to hear the facilitator/SME share the preferred solution for the case study.

##  Additional references

|    |            |
|----------|:-------------:|
| **Description** | **Links** |
| High Availability of SAP HANA on Azure Virtual Machines (VMs) | <https://docs.microsoft.com/en-us/azure/virtual-machines/workloads/sap/sap-hana-high-availability/> |
| HANA + NetWeaver HA on Azure VM | <https://docs.microsoft.com/en-us/azure/virtual-machines/workloads/sap/high-availability-guide-suse> |
| Scripted HANA deployment | <https://github.com/AzureCAT-GSI/SAP-HANA-ARM> |


# SAP HANA on Azure whiteboard design session trainer guide

## Step 1: Review the customer case study

-   Check in with your table participants to introduce yourself as the trainer

-   Ask, "What questions do you have about the customer case study?"

-   Briefly review the steps and timeframes of the whiteboard design session

-   Ready, set, go! Let the table participants begin

## Step 2: Design a proof of concept solution

-   Check in with your tables to ensure that they are transitioning from step to step on time

-   Provide some feedback on their responses to the business needs and design

    -   Try asking questions first that will lead the participants to discover the answers on their own

-   Provide feedback for their responses to the customer's objections

    -   Try asking questions first that will lead the participants to discover the answers on their own
    
## Step 3: Present the solution

-   Determine which table will be paired with your table before Step 3 begins

-   For the first round, assign one table as the presenting team and the other table as the customer

-   Have the presenting team present their solution to the customer team

    -   Have the customer team provide one objection for the presenting team to respond to

    -   The presentation, objections, and feedback should take no longer than 15 minutes

    -   If needed, the trainer may also provide feedback

## Wrap-up

-   Have the table participants reconvene with the larger session group to hear the facilitator/SME share the following preferred solution

##  Preferred target audience

Business Development Manager (BDM) or Application Sponsor (CFO)

-   Funds projects & apps

-   Most interested in public cloud

Business Unit IT / Developers (Director of SAP Business Analysts, Director of SAP Operations)

-   Reports to BDM and is responsible for coding and testing apps

-   Big influencer of public cloud strategy

Central IT (VP of IT Operations)

-   Reports into CIO and responsible for operating datacenter

-   Concerned about shadow IT created issues: security/compliance, server sprawl, and lack of control

## Preferred solution

In order to comply with requirements provided by Contoso Group, the preferred solution consists of several options that provide different degree of resiliency.  

Azure Virtual Machines -- BW on HANA without HA

The first option delivers the core functionality without SAP HANA high availability and disaster recovery capabilities. It implements a cross premises scenario, with the customer’s on-premises corporate network and an Azure datacenter in the East US 2 region. For cross-premises connectivity, it leverages the MPLS-based ExpressRoute circuit. 

As per customer's requirements, the Azure deployment includes Dev, Test, QA, and production environments. The Dev, Test, and QA Azure VMs reside on the same non-PRD subnet. There are two Dev and Test Standard E32v3 Azure VMs, each with one P15 data disk, one P10 transaction log disk, and one P15 shared disk. A single QA Azure VM uses the Standad M64 size, with one P30 data disk, one P20 transaction log disk, and one P30 shared data disk. In order to minimize cost, Dev, Test, and QA Azure VMs can be turned off whenever they are not actively used.

The solution also includes a standalone HANA production database running on a Standard M128s Azure VM, which offers memory-optimized design. The Azure VM is configured with two P30 disks, striped into a single volume hosting data files, which deliver total of 2 TB of disk space and 400 MB/s throughput. Logs are stored on a volume residing on two P15 disks that deliver combined 512 GB of disk space and 250 MB/s throughpupt. The shared HANA volume uses one P30 disk, with 1 TB of disk space and 200 MB/s throughput.

In addition to the Azure VM hosting HANA DB, the solution includes a pair of Azure VMs virtual machines that serve as the ASCS and the application servers. This satisifies the customer requirement, according to which the Business Warehouse application servers must be able to handle 15,000 SAPS. Two E8_v3 Azure VMs give us total of 18,512 SAPS. 

In order to facilitate short term backup, the solution relies on four P30 Premium Storage disks. For long term backups, the solution utilizes Azure Site Recovery vault, with retention of 30 daily, 12 monthly, and 3 yearly backups, yielding the total of 54TB.

![Diagram of the BW on HANA without HA preferred solution. At this time, we are unable to capture all of the information in the diagram. Future versions of this course should address this.](images/Whiteboarddesignsessiontrainerguide-SAPHANAonAzureimages/media/image14.png "BW on HANA without HA preferred solution")

Azure Virtual Machines -- BW on HANA without HA -- Cost estimate

The corresponding monthly cost estimate accounts for compute, storage, and network-related charges calculated based on the resource pricing in the US East 2 Azure region. The network charges include the cost of the metered data plan for ExpressRoute 500 Mbps port speed with the expected outbound data transfer of 5TB per month. There is also an extra charge associated with ExpressRoute High Performance virtual gateway, which can facilitate network throughput of close to 10 Gbps. 

Compute costs result primarily from the use of Azure VMs hosting the SAP production application and database tiers, as well as compute components of the dev/test and QA environments. Storage charges reflect primarily the use of Premium Storage hostng virtual machine disk files. Note that this cost does not depend on the usage patterns. In addition, there is cost resulting from the need for short term and long term backups. 

Note that the charges do not take into account licensing costs, ExpressRoute telco charges, pricing of the Microsoft Premier Support which is required when deploying SAP production solutions in Azure, and any managed services.

![A table displays the cost estimates for BW on HANA without HA. At this time, we are unable to capture all of the information in the table. Future versions of this course should address this.](images/Whiteboarddesignsessiontrainerguide-SAPHANAonAzureimages/media/image15.png "BW on HANA without HA ??? Cost estimate")

Azure Virtual Machines -- BW on HANA with HA

The second option delivers the same core functionality as the first option but, in addition, it provides high availability for the SAP HANA deployment. This is accomplished by provisioning two identically configured M128s Azure VM into the same availabilty set within the PRD-DB subnet. The two Azure VMs form the database tier and host two identically configured HANA instances replicating synchronously with each other by using HANA System Replication. Implementing high availability in the application tier involves provisioning two pairs of Azure VMs into the PRD - ASCS+APPL subnet, with each pair in its own availability set. The first pair consists of two E2_v3 Azure VMs hosting SAP ASCS and NFS components. The second pair consists of a two E8_v3 Azure VMs, forming a Linux-based cluster, hosting the application servers and delivering total of 17,512 SAPS.

![Diagram of the BW on HANA with HA preferred solution. At this time, we are unable to capture all of the information in the diagram. Future versions of this course should address this.](images/Whiteboarddesignsessiontrainerguide-SAPHANAonAzureimages/media/image16.png "BW on HANA with HA preferred solution")

Azure Virtual Machines -- BW on HANA with HA -- Cost estimate

The cost of the second option reflects additional components necessary to provide high availability. These components effectively double the cost of the production instance of the HANA database included in the first option (for both compute and storage resources). In addition, there are extra charges associated with implementing high availability of the application tier. In this case, the increase represents compute and storage resources of two E2_v3 Azure VMs that host the ASCS and NFS components.

![A table displays the cost estimates for BW on HANA with HA. At this time, we are unable to capture all of the information in the table. Future versions of this course should address this.](images/Whiteboarddesignsessiontrainerguide-SAPHANAonAzureimages/media/image17.png "BW on HANA with HA Costs")

SAP HANA HA on Azure VMs -- Setup Sequence

Our sample implementation procedure consists of the following sequence of steps:

-   Provision Azure infrastructure and two Azure Linux VMs
-   Update Linux OS  and install HA extension
-   Enable cross-node SSH access
-   Set up disk layout
-   Configure name resolution
-   Install cluster
-   Configure Corosync
-   Install HANA HA packages
-   Install SAP HANA
-   Upgrade SAP Host Agent
-   Configure HANA replication
-   Configure Cluster Framework
-   Create STONITH device
-   Register SAP HANA resources


SAP HANA HA on Azure VMs -- Setup Sequence (detailed)

We start by provisioning Azure infrastructure and two Azure Linux VMs (using SLES-for-SAP Applications 12 SP3). To simplify the deployment, we leverage an Azure Resource Manager-based template hosted on GitHub. 

The template provisions a pair of Azure VMs into a subnet of a virtual network and behind an Azure internal load balancer. The load balance has the health probe set to TCP 62500 and includes a set of predefined load balancing rules. Each rule  has the Direct Server Return enabled.
Next, since we are using the Bring Your Own Subscription image of SUSE, we  register our installation to ensure access to package repositories. Following the registration, we update the operating system and install the public-cloud module. In order to facilitate clustering, we also enable cross-node passwordless SSH access. 

We set up our disk volumes by using Logical Volume Manager. First, we create physical volumes for all disks, volume groups for the data files, the log files and the shared HANA directory, and the corresponding logical volumes. Next, we create mount directories, identify UUID values of all logical volumes, create relevant fstab entries, and finally perform mounts. This procedure is carried out on both nodes. 

We also configure name resolution by modifying /etc/hosts on each server.
Next, we install cluster on the first node and, once completed, join the second node to the newly set up cluster.

As part of cluster configuration, we  also configure corosync transport and nodelist settings and restart corosync service on both nodes. In addition, we install HANA HA resource agent packages. 

With all prerequisites in place, we proceed with using HANA DB Lifecycle Manager to install SAP HANA. Following the installation we upgrade SAP Host Agent, configure HANA replication and Cluster Framework, create STONITH device in the form of an Azure Active Directory service principal, and, finally, register SAP HANA resources.

Azure virtual machines - BW on HANA with HA/DR

To further enhance our design by providing disaster recovery capabilities, we create a virtual network in the West US Azure region and leverage ExpressRoute to provide cross-region and cross-premises connectivity. Next, we deploy another M128s Azure VM in the newly provisioned virtual network and configure it with asynchronous HANA system replication from the cluster hosting the primary database instance. We also implement a standby disaster recovery environment for the application tier. 

![Diagram of the BW on HANA with HA/DR preferred solution.](images/Whiteboarddesignsessiontrainerguide-SAPHANAonAzureimages/media/image20.png)

*High level solution architecture*

1.  **Design**: What should be the Azure region(s) where the solution should be deployed?

    **Solution** : The first option of our solution delivers core functionality without SAP HANA high availability and disaster recovery capabilities. It provides cross premises connectivity, with the customer’s on-premises corporate network and an Azure datacenter in the East US 2 region. To enhance our design, we offer two additional options that include, incrementally, high availability and disaster recovery provisions. The latter of the two involves implementation of a virtual network in the West US Azure region and leverages MPLS-based ExpressRoute to facilitate cross-region and cross-premises connectivity. 
    
2.  **Design**: Should the customer use a 2-tier or 3-tier architecture for its SAP deployment?

    **Solution** : The 3-tier architecture is necessary in the second and the third option in order to satisfy high-availability requirement stipulated by the customer.

3.  **Design**: How would you ensure that the high-availability and disaster recovery requirements are satisfied?

    **Solution** : Our design offers three options, which allow the customer to choose a solution that provides the required level of high availability and disaster recovery. The first option (Azure Virtual Machines -- BW on HANA without HA) delivers the core functionality without SAP HANA high availability and disaster recovery capabilities. The second option (Azure Virtual Machines -- BW on HANA with HA), delivers the same core functionality as the first option but, in addition, it provides high availability for the SAP HANA deployment. The third option (Azure virtual machines - BW on HANA with HA/DR) further enhances our design by providing disaster recovery capabilities.
    
    *Option 1: Azure Virtual Machines -- BW on HANA without HA*

    ![Diagram of the BW on HANA without HA preferred solution. At this time, we are unable to capture all of the information in the diagram. Future versions of this course should address this.](images/Whiteboarddesignsessiontrainerguide-SAPHANAonAzureimages/media/image14.png "BW on HANA without HA preferred solution")
    
    The first option delivers the core functionality without SAP HANA high availability and disaster recovery capabilities. It accommodates a hybrid scenario, with the customer’s on-premises corporate network and an Azure datacenter in the East US 2 region. For cross-premises connectivity, it leverages the MPLS-based ExpressRoute circuit. 

    The solution also includes a standalone HANA production database running on a Standard M128s, memory-optimized Azure VM. The Azure VM is configured with two P30 disks, striped into a single volume hosting data files, which deliver total of 2 TB of disk space and 400 MB/s throughput. Logs are stored on a volume residing on two P15 disks that deliver combined 512 GB of disk space and 250 MB/s throughpupt. The shared HANA volume uses one P30 disk, with 1 TB of disk space and 200 MB/s throughput.

    In addition to the Azure VM hosting HANA DB, the solution includes a pair of Azure VMs virtual machines that serve as the ASCS and the application servers. This satisifies the customer requirement, according to which the Business Warehouse application servers must be able to handle 15,000 SAPS. Two E8_v3 Azure VMs give us total of 18,512 SAPS. 

    *Option 2: Azure Virtual Machines -- BW on HANA with HA*

    ![Diagram of the BW on HANA with HA preferred solution. At this time, we are unable to capture all of the information in the diagram. Future versions of this course should address this.](images/Whiteboarddesignsessiontrainerguide-SAPHANAonAzureimages/media/image16.png "BW on HANA with HA preferred solution")

    The second option delivers the same core functionality as the first option but, in addition, it provides high availability for the SAP HANA components. This is accomplished by provisioning two identically configured M128s Azure VM into the same availabilty set. The two Azure VMs form the database tier and host two identically configured HANA instances replicating synchronously with each other by using HANA System Replication. Implementing high availability in the application tier involves provisioning two pairs of Azure VMs, with each pair in its own availability set. The first pair consists of two E2_v3 Azure VMs hosting SAP ASCS and NFS components. The second pair consists of a two E8_v3 Azure VMs, forming a Linux-based cluster, hosting the application servers and delivering total of 17,512 SAPS.

    *Option 3: Azure virtual machines - BW on HANA with HA/DR*

    ![Diagram of the BW on HANA with HA/DR preferred solution.](images/Whiteboarddesignsessiontrainerguide-SAPHANAonAzureimages/media/image20.png)

    To further enhance our design by providing disaster recovery capabilities, we create a virtual network in the West US Azure region and leverage MPLS-based ExpressRoute to provide cross-region and cross-premises connectivity. Next, we deploy another M128s Azure VM in the newly provisioned virtual network and configure it with asynchronous HANA system replication from the cluster hosting the primary database instance. We also implement a standby disaster recovery environment for the application tier. 

*Network design:*

1.  **Design**: What should be the hybrid connectivity option?

    **Solution** : Each option in our solution accounts for the need for hybrid connectivity, with the customer’s on-premises corporate network and an Azure datacenter in the East US 2 region. For cross-premises connectivity, our design leverages an MPLS-based ExpressRoute circuit. The third option, providing disaster recovery capabilities, includes a virtual network in the West US Azure region and leverages MPLS-based ExpressRoute to provide cross-region and cross-premises connectivity.

2.  **Design**: What should be the Azure virtual network design in order to maximize security?

    **Solution** : All connectivity between on-premises networks and Azure virtual networks is provided by using private connections via MPLS-based ExpressRoute. 

*SAP deployment architecture:*

1.  **Design**: What will be the configuration of the application and database components of your solution?

    **Solution** : The first option includes a standalone HANA production database and a pair of Azure VMs virtual machines that serve as the ASCS and the application servers. The second option provides high availability for the SAP HANA deployment. This is accomplished by provisioning two identically configured Azure VM into the same availabilty set. The two Azure VMs form the database tier and host two identically configured HANA instances replicating synchronously with each other by using HANA System Replication. Implementing high availability in the application tier involves provisioning two pairs of Azure VMs, with each pair in its own availability set. The first pair consists of two Azure VMs hosting SAP ASCS and NFS components. The second pair consists of a two Azure VMs, forming a Linux-based cluster, hosting the application servers. The third option includes another Azure VM hosting HANA database configured asynchronous HANA system replication from the cluster hosting the primary database instance. We also implement a standby disaster recovery environment for the application tier. 

2.  **Design**: What Azure VM sizes do you intend to use?

    **Solution** : As per customer's requirements, the Azure deployment includes Dev, Test, QA, and production environments. There are two Dev and Test Standard E32v3 Azure VMs, each with one P15 data disk, one P10 transaction log disk, and one P15 shared disk. A single QA Azure VM uses the Standad M64 size, with one P30 data disk, one P20 transaction log disk, and one P30 shared data disk.

    The first option of our solution includes the standalone HANA production database running on a Standard M128s Azure VM, which offers memory-optimized design. The Azure VM is configured with two P30 disks, striped into a single volume hosting data files, which deliver total of 2 TB of disk space and 400 MB/s throughput. Logs are stored on a volume residing on two P15 disks that deliver combined 512 GB of disk space and 250 MB/s throughpupt. The shared HANA volume uses one P30 disk, with 1 TB of disk space and 200 MB/s throughput. In addition to the Azure VM hosting HANA DB, the solution includes two Azure VMs virtual machines that serve as the ASCS and the application servers. This satisifies the customer requirement, according to which the Business Warehouse application servers must be able to handle 15,000 SAPS. Two E8_v3 Azure VMs give us total of 18,512 SAPS. 

    The second option relies on two identically configured M128s Azure VM that form the database tier and host two identically configured HANA instances replicating synchronously with each other by using HANA System Replication. Implementing high availability in the application tier involves provisioning two pairs of Azure VMs. The first pair consists of two E2_v3 Azure VMs hosting SAP ASCS and NFS components. The second pair consists of a two E8_v3 Azure VMs, forming a Linux-based cluster, hosting the application servers and delivering total of 17,512 SAPS.

    The third option incluees another M128s Azure VM in the West US2 Azure region hosting a HANA instance configured with asynchronous HANA system replication from the cluster hosting the primary database instance. We also implement standby disaster recovery environment for the application tier by using Azure Site Recovery.

3.  **Design**: What other Azure resources will be part of your solution?

    **Solution** : In order to facilitate short term backup, the solution relies on four P30 Premium Storage disks. For long term backups, the solution utilizes Azure Site Recovery vault, with retention of 30 daily, 12 monthly, and 3 yearly backups, yielding the total of 54TB. We also rely on Azure Site Recovery for maintaining replicas of the application tier Azure VMs in the secondary region.
    
*Solution cost:*

1.  **Design**: What is the estimated cost of your solution without HA/DR?

    **Solution** : The monthly cost estimate accounts for compute, storage, and network-related charges calculated based on the resource pricing in the US East 2 Azure region. The network charges include the cost of the metered data plan for ExpressRoute 500 Mbps port speed with the expected outbound data transfer of 5TB per month. There is also an extra charge associated with ExpressRoute High Performance virtual gateway, which can facilitate network throughput of close to 10 Gbps. 

    Compute costs result primarily from the use of Azure VMs hosting the SAP production application and database tiers, as well as compute components of the dev/test and QA environments. Storage charges reflect primarily the use of Premium Storage hostng virtual machine disk files. Note that this cost does not depend on the usage patterns. In addition, there is cost resulting from the need for short term and long term backups. 

    Note that the charges do not take into account licensing costs, ExpressRoute telco charges, pricing of the Microsoft Premier Support which is required when deploying SAP production solutions in Azure, and any managed services.
    
    In order to minimize cost, Dev, Test, and QA Azure VMs can be turned off whenever they are not actively used.

![A table displays the cost estimates for BW on HANA without HA. At this time, we are unable to capture all of the information in the table. Future versions of this course should address this.](images/Whiteboarddesignsessiontrainerguide-SAPHANAonAzureimages/media/image15.png "BW on HANA without HA ??? Cost estimate")

2.  **Design**: What is the estimated cost of your solution with HA?

    **Solution** : The extra cost of the second option reflects charges associated with the additional components necessary to provide high availability. These components effectively double the cost of the production instance of the HANA database included in the first option (for both compute and storage resources). In addition, there are extra charges associated with implementing high availability of the application tier. In this case, the increase represents compute and storage resources of two E2_v3 Azure VMs that host the ASCS and NFS components.

    Note that the charges do not take into account licensing costs, ExpressRoute telco charges, pricing of the Microsoft Premier Support which is required when deploying SAP production solutions in Azure, and any managed services.

![A table displays the cost estimates for BW on HANA with HA. At this time, we are unable to capture all of the information in the table. Future versions of this course should address this.](images/Whiteboarddesignsessiontrainerguide-SAPHANAonAzureimages/media/image17.png "BW on HANA with HA Costs")

3.  **Design**:  What is the estimated cost of your solution with HA/DR?

    **Solution** : The extra cost of the third option reflects charges associated with additional components necessary to provide disaster recovery. These components effectively represent the cost of the production instance of the HANA database included in the first option (for both compute and storage resources). In addition, there are extra charges associated with implementing high availability of the application tier. In this case, the increase represents storage resources of two E2_v3 Azure VMs that host the ASCS and NFS components as well as Azure VMs hosting the SAP production application tier. There is also an added cost of Azure Site Recovery.
 
    Note that the charges do not take into account licensing costs, ExpressRoute telco charges, pricing of the Microsoft Premier Support which is required when deploying SAP production solutions in Azure, and any managed services.


## Checklist of preferred objection handling

1.  ECC remains on-premises until Dec CY19. How can we maintain integrations between ECC and BW?

    -   Microsoft supports a hybrid solution, with symmetry between on-premises applications and those on the public cloud

    -   Windows Azure Virtual Network allows to create a logically isolated section in Azure and securely connect it to on premises datacenters

    -   ExpressRoute provides secure, high-bandwidth, low-latency connectivity between Azure and on-premises datacenters

2.  How much does Azure cost? Give us a few options (e.g. HA and non-HA, DR and non-DR).

    -   The proposed design offers three options:

        -   Non-HA

        -   HA with no DR

        -   HA and DR

    -   For mission-critical SAP applications using SAP HANA, high availability can be achieved through a highly resilient architecture with active and standby systems that have databases running with data replication. If a deployment is non-mission critical, it is possible to ensure high availability for just the data and spin up necessary compute on-demand in the event of a failure.

    -   Disaster recovery can leverage:

        -   Azure Site Recovery Services (A2A scenario)

            -   Replicates SAP application instance VMs and ASCS/SCS VMs to second SAP Azure region

            -   VMs in DR region regions are not up and running (no compute costs)

        -   SAP HANA System Replication in asynchronous replication mode

3.  Do I have to pay for virtual machines when they are stopped?

    -   Azure VM must be in the stopped (deallocated) state in order to avoid compute charges. If the VM is stopped it will continue to incur charges.

    -   Deallocating does not mean deleting the VM as it still exists in storage.

    -   You will still incur storage charge even if the VM is deallocated.

4.  Can I automate the shutdown of virtual machines at periodic times of day?

    -   Yes, this functionality is available directly from the Azure portal. Alternatively, you can use Azure Automation runbooks or custom Azure PowerShell and Azure CLI scripts to stop and deallocate any instance.

    -   The same tools can be used to start the instance on a scheduled time.

    -   Note that the built-in platform auto-shutdown functionality does not provide the draining functionality of application servers, so it is important to verify that these servers do not have any active tasks before initiating shutdown. This can be implemented by using Azure Automation or Azure functions.

## Customer quote (to be read back to the attendees at the end)

"Azure has provided high availability and disaster recovery capabilities for our production environment at a very reasonable price."

Andrew Cross, CIO, Contoso Group

